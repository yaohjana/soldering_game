<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>焊接特訓班 V11：職人考核版</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=M+PLUS+Rounded+1c:wght@400;800&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --dora-blue: #0093DD;
            --dora-red: #DD0000;
            --dora-yellow: #F2C906;
            --dora-white: #FFFFFF;
            --dora-black: #333333;
        }

        body {
            margin: 0;
            background-color: #E0F7FF;
            background-image: radial-gradient(#fff 20%, transparent 20%);
            background-size: 20px 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            font-family: 'M PLUS Rounded 1c', sans-serif;
            overflow: hidden; user-select: none;
            color: var(--dora-black);
        }

        /* --- 頂部資訊欄 --- */
        .hud-bar {
            display: flex; gap: 20px; margin-top: 10px; z-index: 10;
            align-items: center;
        }
        .badge {
            background: var(--dora-blue); color: white;
            padding: 5px 20px; border-radius: 30px;
            border: 3px solid var(--dora-black);
            font-size: 1.2rem; font-weight: 800;
            box-shadow: 4px 4px 0 rgba(0,0,0,0.1);
            display: flex; align-items: center; gap: 10px;
        }
        .progress-bells { display: flex; gap: 8px; }
        .bell {
            width: 20px; height: 20px;
            background: #ccc; border: 2px solid var(--dora-black);
            border-radius: 50%; position: relative; transition: all 0.3s;
        }
        .bell.active { background: var(--dora-yellow); transform: scale(1.2); box-shadow: 0 0 10px var(--dora-yellow); }

        /* --- 遊戲主舞台 --- */
        #game-container {
            position: relative;
            width: 900px; height: 450px; /* 稍微縮小高度給下方留空間 */
            background: #fff;
            border: 6px solid var(--dora-blue);
            border-radius: 30px;
            margin: 10px; overflow: hidden; cursor: none;
            box-shadow: inset 0 0 30px rgba(0,147,221, 0.15);
            outline: none;
        }

        /* PCB */
        .pcb-board {
            position: absolute; width: 750px; height: 120px; background: #006633;
            top: 45%; left: 50%; transform: translate(-50%, -50%);
            border-radius: 10px; border: 4px solid #004422;
            display: flex; justify-content: space-around; align-items: center;
            padding: 0 20px; box-shadow: inset 0 0 20px rgba(0,0,0,0.3); z-index: 5;
        }
        .solder-point { width: 80px; height: 80px; position: relative; display: flex; justify-content: center; align-items: center; }
        .pad {
            width: 60px; height: 60px; background: #C0C0C0; border: 3px solid #888; border-radius: 50%;
            position: absolute; z-index: 1; transition: all 0.2s;
        }
        .pad::after { content:''; position:absolute; width:8px; height:8px; background:#333; border-radius:50%; top:50%; left:50%; transform:translate(-50%,-50%); }
        .pad.active { border-color: var(--dora-blue); box-shadow: 0 0 15px var(--dora-blue); background: #fff; animation: pulse 1s infinite; }
        .pad.heating { background: #ff9999; border-color: var(--dora-red); box-shadow: 0 0 25px var(--dora-red); }
        
        .pad.done-s { background: #fff; border-color: #fff; box-shadow: inset 0 0 10px #999; }
        .pad.done-a { background: #ddd; border-color: #aaa; }
        .pad.done-bad { background: #555; border-color: #000; }
        
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        
        .blob { width: 0; height: 0; border-radius: 50%; position: absolute; z-index: 3; background: radial-gradient(circle at 30% 30%, #fff, #aaa); transition: all 0.1s; }
        .blob.spiky { border-radius: 50% 50% 0 50%; transform: rotate(-45deg); background: #777; }
        .pin { width: 12px; height: 12px; background: #B87333; border-radius: 50%; position: absolute; z-index: 2; }

        /* 溫度計 */
        .temp-gauge-box {
            position: absolute; top: 20px; right: 20px;
            background: white; border: 3px solid var(--dora-black);
            padding: 8px 15px; border-radius: 15px; font-weight: bold;
            display: flex; flex-direction: column; align-items: flex-end; z-index: 10;
        }
        #temp-bar { height: 100%; width: 0%; background: linear-gradient(90deg, var(--dora-yellow), var(--dora-red)); }
        .temp-bar-wrap { width: 120px; height: 12px; background: #eee; border: 2px solid #333; border-radius: 6px; overflow: hidden; margin-bottom: 5px;}

        /* 工具 - 圖層調整到最上層 (z-index 999) */
        #tool-solder {
            position: absolute; top: 400px; left: 50px; 
            pointer-events: none; transition: transform 0.05s; 
            z-index: 999; /* 最上層 */
        }
        .solder-stick {
            width: 180px; /* 改短 */
            height: 8px; background: #d0d0d0; border: 2px solid #666;
            position: absolute; top: 20px; left: 0px; transform-origin: left center; transform: rotate(-15deg);
        }
        #solder-tip { 
            position: absolute; right: -5px; top: 50%; transform: translateY(-50%);
            width: 8px; height: 8px; background: red; border-radius: 50%; box-shadow: 0 0 8px red; border: 1px solid white;
        }
        .hand-ball-l { width: 50px; height: 50px; background: white; border: 3px solid var(--dora-black); border-radius: 50%; position: absolute; top: -10px; left: -20px; }

        #tool-iron { 
            position: absolute; top: -100px; left: -100px; 
            pointer-events: none; 
            z-index: 999; /* 最上層 */
        }
        .iron-body {
            width: 25px; height: 150px; background: var(--dora-blue);
            border: 3px solid var(--dora-black); border-radius: 8px;
            position: absolute; top: -110px; left: 10px; transform: rotate(30deg);
        }
        .iron-head {
            width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent;
            border-top: 35px solid #E6B422; position: absolute; bottom: -30px; left: 0;
        }
        .iron-head.hot { border-top-color: var(--dora-red); filter: drop-shadow(0 0 15px red); }
        .hand-ball-r { width: 50px; height: 50px; background: white; border: 3px solid var(--dora-black); border-radius: 50%; position: absolute; top: -20px; left: -10px; }
        #iron-tip { position: absolute; bottom: -30px; left: 12px; width: 2px; height: 2px; }

        /* --- 評分紀錄區 (新增) --- */
        .feedback-area {
            width: 900px;
            display: flex; gap: 10px;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        .feedback-card {
            flex: 1;
            background: white;
            border: 3px solid #ccc;
            border-radius: 10px;
            padding: 10px;
            font-size: 0.85rem;
            min-height: 80px;
            display: flex; flex-direction: column;
            align-items: center; text-align: center;
            transition: all 0.3s;
        }
        .feedback-card.active { border-color: var(--dora-blue); background: #f0faff; transform: scale(1.05); box-shadow: 0 4px 0 rgba(0,0,0,0.1); }
        .fb-num { font-weight: 900; color: #999; font-size: 1.2rem; margin-bottom: 5px; }
        .fb-grade { font-size: 1.5rem; font-weight: 900; }
        .fb-msg { color: #666; line-height: 1.2; margin-top: 5px;}

        .grade-s { color: var(--dora-blue); }
        .grade-a { color: #F2C906; text-shadow: 1px 1px 0 #999; }
        .grade-f { color: var(--dora-red); }

        /* 遮罩 */
        .overlay {
            position: absolute; top:0; left:0; width:100%; height:100%;
            background: rgba(0, 147, 221, 0.95);
            display: none; flex-direction: column; justify-content: center; align-items: center;
            z-index: 2000; /* 比工具更高 */
            color: white;
        }
        .result-card {
            background: white; color: var(--dora-black);
            padding: 30px 50px; border-radius: 30px; border: 6px solid var(--dora-black);
            text-align: center; box-shadow: 15px 15px 0 rgba(0,0,0,0.2);
            transform: rotate(-2deg);
            max-width: 600px;
        }
        .btn-start {
            padding: 15px 40px; font-size: 1.5rem; font-weight: bold;
            background: var(--dora-yellow); border: 3px solid var(--dora-black);
            border-radius: 50px; cursor: pointer; margin-top: 20px;
            box-shadow: 4px 4px 0 var(--dora-black); transition: transform 0.1s;
        }
        .btn-start:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0 var(--dora-black); }
        
        .title-banner {
            background: var(--dora-red); color: white; padding: 5px 20px;
            font-size: 1.5rem; font-weight: 900; transform: rotate(-3deg) scale(1.1);
            margin: 10px 0; border: 3px solid white; box-shadow: 3px 3px 0 rgba(0,0,0,0.3);
        }

    </style>
</head>
<body>

    <div class="hud-bar">
        <div class="badge">
            <div style="width:15px; height:15px; background:red; border-radius:50%; border:2px solid #000;"></div>
            考核計時：<span id="timer-display">00.0</span>s
        </div>
        <div class="progress-bells">
            <div class="bell" id="bell-0"></div>
            <div class="bell" id="bell-1"></div>
            <div class="bell" id="bell-2"></div>
            <div class="bell" id="bell-3"></div>
            <div class="bell" id="bell-4"></div>
        </div>
    </div>

    <div id="game-container" tabindex="0">
        
        <div class="temp-gauge-box">
            <div class="temp-bar-wrap"><div id="temp-bar"></div></div>
            <span id="temp-text">25°C</span>
        </div>

        <div class="pcb-board">
            <!-- 焊點 1-5 -->
            <div class="solder-point"><div class="pad" id="pad-0"></div><div class="pin"></div><div class="blob" id="blob-0"></div></div>
            <div class="solder-point"><div class="pad" id="pad-1"></div><div class="pin"></div><div class="blob" id="blob-1"></div></div>
            <div class="solder-point"><div class="pad" id="pad-2"></div><div class="pin"></div><div class="blob" id="blob-2"></div></div>
            <div class="solder-point"><div class="pad" id="pad-3"></div><div class="pin"></div><div class="blob" id="blob-3"></div></div>
            <div class="solder-point"><div class="pad" id="pad-4"></div><div class="pin"></div><div class="blob" id="blob-4"></div></div>
        </div>

        <!-- 左手焊錫 (Z-Index 999) -->
        <div id="tool-solder">
            <div class="solder-stick"><div id="solder-tip"></div></div>
            <div class="hand-ball-l"></div>
        </div>

        <!-- 右手烙鐵 (Z-Index 999) -->
        <div id="tool-iron">
            <div class="iron-body"><div class="iron-head"></div><div id="iron-tip"></div></div>
            <div class="hand-ball-r"></div>
        </div>

        <!-- 開始畫面 -->
        <div id="start-screen" class="overlay" style="display:flex;">
            <div class="result-card">
                <h1>焊接職人考核</h1>
                <p style="color: #0093DD; font-weight:bold;">V11.0 最終修正版</p>
                <div style="text-align:left; background:#f0f0f0; padding:15px; border-radius:10px; margin:10px 0; font-size:0.9rem; line-height:1.6;">
                    <strong>考核重點：</strong><br>
                    1. 焊錫長度已改短，操作更靈活。<br>
                    2. 每個焊點完成後，下方會有即時建議。<br>
                    3. 請注意<b>撤離順序</b>：先移焊錫，再移烙鐵。<br>
                    4. 最終將根據表現授予對應稱號。
                </div>
                <button class="btn-start" onclick="startGame()">開始考核</button>
            </div>
        </div>

        <!-- 結算畫面 -->
        <div id="result-screen" class="overlay">
            <div class="result-card">
                <h2>考核結束！</h2>
                <div class="title-banner" id="final-title">稱號載入中...</div>
                <div style="font-size:3rem; color:#333; margin:10px 0;" id="final-score">S</div>
                <p id="final-msg" style="font-weight:bold; color:#666;">評語載入中...</p>
                <p id="final-stats" style="font-size:0.9rem;">...</p>
                <button class="btn-start" onclick="resetGame()">再次挑戰</button>
            </div>
        </div>
    </div>

    <!-- 底部評分建議區 -->
    <div class="feedback-area">
        <div class="feedback-card" id="fb-0"><div class="fb-num">1</div><div class="fb-grade">-</div><div class="fb-msg">待焊接</div></div>
        <div class="feedback-card" id="fb-1"><div class="fb-num">2</div><div class="fb-grade">-</div><div class="fb-msg">待焊接</div></div>
        <div class="feedback-card" id="fb-2"><div class="fb-num">3</div><div class="fb-grade">-</div><div class="fb-msg">待焊接</div></div>
        <div class="feedback-card" id="fb-3"><div class="fb-num">4</div><div class="fb-grade">-</div><div class="fb-msg">待焊接</div></div>
        <div class="feedback-card" id="fb-4"><div class="fb-num">5</div><div class="fb-grade">-</div><div class="fb-msg">待焊接</div></div>
    </div>

    <script>
        /* ================= 音效系統 ================= */
        const AudioSys = {
            ctx: null, sizzleGain: null,
            init: function() {
                window.AudioContext = window.AudioContext || window.webkitAudioContext;
                this.ctx = new AudioContext();
                const bSize = 2 * this.ctx.sampleRate;
                const buf = this.ctx.createBuffer(1, bSize, this.ctx.sampleRate);
                const out = buf.getChannelData(0);
                for(let i=0; i<bSize; i++) out[i] = Math.random()*2-1;
                const noise = this.ctx.createBufferSource();
                noise.buffer = buf; noise.loop = true;
                const filter = this.ctx.createBiquadFilter();
                filter.type = 'lowpass'; filter.frequency.value = 1000;
                this.sizzleGain = this.ctx.createGain();
                this.sizzleGain.gain.value = 0;
                noise.connect(filter); filter.connect(this.sizzleGain);
                this.sizzleGain.connect(this.ctx.destination);
                noise.start();
            },
            setSizzle: function(vol) {
                if(!this.ctx) return;
                this.sizzleGain.gain.setTargetAtTime(vol * 0.2, this.ctx.currentTime, 0.1);
            },
            playDing: function() {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                o.frequency.setValueAtTime(880, t); o.frequency.exponentialRampToValueAtTime(1760, t+0.1);
                g.gain.setValueAtTime(0.1, t); g.gain.exponentialRampToValueAtTime(0.001, t+0.5);
                o.connect(g); g.connect(this.ctx.destination); o.start(t); o.stop(t+0.5);
            },
            playWin: function() {
                if(!this.ctx) return;
                const t = this.ctx.currentTime;
                [523, 659, 783, 1046].forEach((f, i) => {
                    const o = this.ctx.createOscillator(); const g = this.ctx.createGain();
                    o.type='triangle'; o.frequency.value=f;
                    g.gain.setValueAtTime(0, t+i*0.1); g.gain.linearRampToValueAtTime(0.1, t+i*0.1+0.05);
                    g.gain.exponentialRampToValueAtTime(0.001, t+i*0.1+2);
                    o.connect(g); g.connect(this.ctx.destination); o.start(t+i*0.1); o.stop(t+i*0.1+2);
                });
            }
        };

        /* ================= 遊戲邏輯 ================= */
        const CONFIG = { heatRate: 2.5, coolRate: 3.0, meltTemp: 180, maxTemp: 400, idealMin: 65, idealMax: 90 };
        let state = {
            mode: 'MENU', currentPadIdx: 0, startTime: 0, pads: [], 
            ironPos: {x:0, y:0}, solderPos: {x: 50, y: 400}, temp: 25, 
            mouseDown: false, keys: {}, audioReady: false,
            lastSolderTime: 0, lastIronTime: 0
        };

        const els = {
            container: document.getElementById('game-container'),
            iron: document.getElementById('tool-iron'),
            ironHead: document.querySelector('.iron-head'),
            ironTip: document.getElementById('iron-tip'),
            solder: document.getElementById('tool-solder'),
            solderTip: document.getElementById('solder-tip'),
            tempBar: document.getElementById('temp-bar'),
            tempText: document.getElementById('temp-text'),
            timer: document.getElementById('timer-display'),
            bells: [], pads: [], blobs: [], feedbacks: []
        };

        for(let i=0; i<5; i++) {
            els.bells.push(document.getElementById(`bell-${i}`));
            els.pads.push(document.getElementById(`pad-${i}`));
            els.blobs.push(document.getElementById(`blob-${i}`));
            els.feedbacks.push(document.getElementById(`fb-${i}`));
        }

        let rects = { container: null, pads: [] };

        function initInputs() {
            els.container.addEventListener('mousedown', () => {
                els.container.focus();
                if(!state.audioReady) { AudioSys.init(); state.audioReady = true; }
                state.mouseDown = true;
            });
            window.addEventListener('mouseup', () => state.mouseDown = false);
            els.container.addEventListener('mousemove', e => {
                if(state.mode !== 'PLAY') return;
                state.ironPos.x = e.clientX - rects.container.left;
                state.ironPos.y = e.clientY - rects.container.top;
            });

            window.addEventListener('keydown', e => {
                state.keys[e.code] = true; state.keys[e.key] = true; 
                if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight'].includes(e.code)) e.preventDefault();
            });
            window.addEventListener('keyup', e => {
                state.keys[e.code] = false; state.keys[e.key] = false;
            });
        }

        function updateRects() {
            rects.container = els.container.getBoundingClientRect();
            rects.pads = els.pads.map(p => {
                const r = p.getBoundingClientRect();
                return { x: r.left + r.width/2 - rects.container.left, y: r.top + r.height/2 - rects.container.top, radius: r.width/2 };
            });
        }

        function startGame() {
            updateRects();
            els.container.focus(); 
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('result-screen').style.display = 'none';
            
            state.mode = 'PLAY';
            state.currentPadIdx = 0;
            state.startTime = Date.now();
            state.temp = 25;
            state.pads = Array(5).fill().map(() => ({ size: 0, done: false, status: '' }));
            state.solderPos = {x: 50, y: 350};
            
            els.pads.forEach(p => { p.className = 'pad'; });
            els.blobs.forEach(b => { 
                b.style.width = 0; b.style.height = 0; b.style.background = ''; b.className = 'blob';
            });
            els.bells.forEach(b => b.classList.remove('active'));
            els.feedbacks.forEach(f => {
                f.className = 'feedback-card';
                f.querySelector('.fb-grade').innerText = '-';
                f.querySelector('.fb-msg').innerText = '待焊接';
            });
            
            activatePad(0);
            loop();
        }

        function activatePad(idx) {
            els.pads[idx].classList.add('active');
            els.feedbacks[idx].classList.add('active');
        }

        function loop() {
            if(state.mode !== 'PLAY') return;
            els.timer.innerText = ((Date.now() - state.startTime)/1000).toFixed(1);

            const speed = 6;
            const up = state.keys['KeyW'] || state.keys['ArrowUp'] || state.keys['w'] || state.keys['W'];
            const down = state.keys['KeyS'] || state.keys['ArrowDown'] || state.keys['s'] || state.keys['S'];
            const left = state.keys['KeyA'] || state.keys['ArrowLeft'] || state.keys['a'] || state.keys['A'];
            const right = state.keys['KeyD'] || state.keys['ArrowRight'] || state.keys['d'] || state.keys['D'];

            if(up) state.solderPos.y -= speed;
            if(down) state.solderPos.y += speed;
            if(left) state.solderPos.x -= speed;
            if(right) state.solderPos.x += speed;
            
            // 擴大移動範圍
            state.solderPos.x = Math.max(-100, Math.min(850, state.solderPos.x));
            state.solderPos.y = Math.max(0, Math.min(450, state.solderPos.y));

            els.iron.style.left = (state.ironPos.x - 40) + 'px';
            els.iron.style.top = (state.ironPos.y - 30) + 'px';
            els.solder.style.left = state.solderPos.x + 'px';
            els.solder.style.top = state.solderPos.y + 'px';

            processPhysics();
            requestAnimationFrame(loop);
        }

        function processPhysics() {
            if(state.currentPadIdx >= 5) return;
            const target = rects.pads[state.currentPadIdx];
            const iRect = els.ironTip.getBoundingClientRect();
            const sRect = els.solderTip.getBoundingClientRect();
            const iX = iRect.left - rects.container.left; const iY = iRect.top - rects.container.top;
            const sX = sRect.left - rects.container.left; const sY = sRect.top - rects.container.top;

            const distIron = Math.hypot(iX - target.x, iY - target.y);
            const distSolder = Math.hypot(sX - target.x, sY - target.y);
            const ironOnPad = distIron < target.radius;
            const solderOnPad = distSolder < target.radius;

            // Heating
            let isHeating = false;
            if(state.mouseDown && ironOnPad) {
                state.temp = Math.min(CONFIG.maxTemp, state.temp + CONFIG.heatRate);
                isHeating = true;
                els.pads[state.currentPadIdx].classList.add('heating');
                els.ironHead.classList.add('hot');
                state.lastIronTime = Date.now();
            } else {
                state.temp = Math.max(25, state.temp - CONFIG.coolRate);
                els.pads[state.currentPadIdx].classList.remove('heating');
                els.ironHead.classList.remove('hot');
            }

            // Melting
            let isMelting = false;
            if(state.temp > CONFIG.meltTemp && solderOnPad) {
                isMelting = true;
                state.pads[state.currentPadIdx].size += 0.8;
                state.lastSolderTime = Date.now();
                
                // 更新即時建議狀態 (文字回饋)
                const curSize = state.pads[state.currentPadIdx].size;
                if(curSize > CONFIG.idealMin) updateFeedbackUI(state.currentPadIdx, '...', "焊錫量足夠，請撤離！");
                else updateFeedbackUI(state.currentPadIdx, '...', "融錫中...");

            } else if(solderOnPad && state.temp < CONFIG.meltTemp) {
                updateFeedbackUI(state.currentPadIdx, '...', "溫度不足，請先預熱！");
            }

            // Visuals
            const size = state.pads[state.currentPadIdx].size;
            const blob = els.blobs[state.currentPadIdx];
            blob.style.width = size + 'px'; blob.style.height = size + 'px';
            AudioSys.setSizzle(isHeating ? (isMelting ? 0.8 : 0.4) : 0);
            els.tempBar.style.width = (state.temp / CONFIG.maxTemp * 100) + '%';
            els.tempText.innerText = Math.floor(state.temp) + '°C';

            // Fail Checks
            if(state.temp >= CONFIG.maxTemp) { finishPad('F', '烙鐵停留太久，焊盤燒焦了！'); return; }
            if(size > 110) { finishPad('F', '焊錫加太多，造成短路！'); return; }

            // Withdraw Check
            if(size > 20 && !ironOnPad && !isHeating) {
                const timeDiff = state.lastIronTime - state.lastSolderTime;
                if (solderOnPad) finishPad('F', '產生拉絲！請先移開焊錫，再移烙鐵。');
                else if (timeDiff < 1000) finishPad('S', '完美的撤離時機！光澤漂亮。');
                else finishPad('A', '烙鐵停留太久，助焊劑揮發，焊點變霧了。');
            }
        }

        function updateFeedbackUI(idx, grade, msg) {
            const fb = els.feedbacks[idx];
            const gEl = fb.querySelector('.fb-grade');
            const mEl = fb.querySelector('.fb-msg');
            gEl.innerText = grade;
            mEl.innerText = msg;
            
            gEl.className = 'fb-grade'; // reset
            if(grade === 'S') gEl.classList.add('grade-s');
            if(grade === 'A') gEl.classList.add('grade-a');
            if(grade === 'F') gEl.classList.add('grade-f');
        }

        function finishPad(forcedGrade, advice) {
            const idx = state.currentPadIdx;
            const size = state.pads[idx].size;
            let q = forcedGrade;

            // 如果沒強制，則檢查大小
            if(!q) {
                 if(size >= CONFIG.idealMin && size <= CONFIG.idealMax) q = 'S';
                 else if(size < CONFIG.idealMin) q = 'B';
                 else q = 'A';
            }
            
            // 最終建議微調
            if(q === 'B' && !advice) advice = "焊錫量不足，容易空焊。";
            if(q === 'A' && !advice) advice = "焊錫稍多，形狀不夠完美。";

            state.pads[idx].status = q; state.pads[idx].done = true;
            els.pads[idx].classList.remove('active', 'heating');
            
            const blob = els.blobs[idx];
            const pad = els.pads[idx];

            if(q === 'S') {
                blob.style.background = "radial-gradient(circle at 30% 30%, #fff, #ccc)";
                pad.classList.add('done-s');
            } else if (q === 'A') {
                blob.style.background = "#bbb"; pad.classList.add('done-a');
            } else {
                if(advice.includes('拉絲')) blob.classList.add('spiky');
                blob.style.background = "#555"; pad.classList.add('done-bad');
            }

            updateFeedbackUI(idx, q, advice);
            els.bells[idx].classList.add('active');
            els.feedbacks[idx].classList.remove('active'); // remove highlight
            
            AudioSys.playDing();
            nextPad();
        }

        function nextPad() {
            state.currentPadIdx++;
            state.temp = 25;
            if(state.currentPadIdx < 5) {
                activatePad(state.currentPadIdx);
                state.solderPos.x = 50; state.solderPos.y = 350;
            } else endGame();
        }

        function endGame() {
            state.mode = 'RESULT';
            AudioSys.setSizzle(0); AudioSys.playWin();
            const time = ((Date.now() - state.startTime)/1000).toFixed(1);
            const perfects = state.pads.filter(p => p.status === 'S').length;
            const fails = state.pads.filter(p => p.status === 'F').length;
            
            // 稱號系統
            let title = "";
            let msg = "";
            let score = "";
            
            if(fails > 2) {
                score = "C"; title = "新手學徒"; msg = "別氣餒！請再複習一次撤離的順序，再試一次吧！";
            } else if(perfects === 5) {
                score = "SS"; title = "傳說中的焊接神之手"; msg = "太完美了！你的技術已經可以去焊接主機板了！";
            } else if(perfects >= 3) {
                score = "S"; title = "特級焊接職人"; msg = "表現非常優秀！只差一點點就完美了！";
            } else {
                score = "A"; title = "熟練的技工"; msg = "基礎很穩固，但在撤離時機上可以更果斷一點！";
            }

            document.getElementById('final-score').innerText = score;
            document.getElementById('final-title').innerText = title;
            document.getElementById('final-msg').innerText = msg;
            document.getElementById('final-stats').innerHTML = `耗時: ${time}s <br> 完美: ${perfects} | 失敗: ${fails}`;
            document.getElementById('result-screen').style.display = 'flex';
        }

        function resetGame() { startGame(); }

        initInputs();
        window.onresize = updateRects;
        window.onload = updateRects;

    </script>
</body>
</html>
